<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>地图编辑器</title>
  <style>
    *{
      margin: 0;
      padding: 0;
    }
    #map{
      width: 800px;
      display: flex;
      flex-wrap: wrap;
    }
    .box{
      width: 6px;
      height: 6px;
      display: inline-block;
      vertical-align: top;
      background-color: #eee;
      border: 1px solid #e1e2e3;
    }
  </style>
</head>
<body>
  <div id="map">
  </div>

  <button id="save">保存地图</button>
  <button id="clear">清除地图</button>

  <script>
    let map = localStorage['map'] ? JSON.parse(localStorage['map']) : Array(10000).fill(0);
    let container = document.getElementById('map');
    let save = document.getElementById('save');
    let clear = document.getElementById('clear');

    let isMousedown = false;
    let isClear = false;

    save.onclick = function () {
      localStorage['map'] = JSON.stringify(map);
    }

    clear.onclick = function () {
      map = Array(10000).fill(0);
      render(map);
    }

    //鼠标按下
    document.addEventListener('mousedown', e => {
      isMousedown = true;
      isClear = (e.which === 3);
    });
    //鼠标松开
    document.addEventListener('mouseup', e => {
      isMousedown = false;
    });
    //禁止右键菜单
    document.addEventListener('contextmenu', e => {
      e.preventDefault();
    });

    // 生成画布
    function render(map) {
      container.innerHTML = '';
      for (let y = 0; y < 100; y++) {
        for (let x = 0; x < 100; x++) {
          let box = document.createElement('div');
          box.classList.add('box');

          if (map[100 * y + x] === 1) {
            box.style.backgroundColor = 'black';
          }

          // 鼠标移动
          box.addEventListener('mousemove', () => {
            // 鼠标按下
            if (isMousedown) {
              // 清除
              if (isClear) {
                box.style.backgroundColor = '';
                map[100*y + x] = 0;
              } else {
                // 花点
                box.style.backgroundColor = 'black';
                map[100*y + x] = 1;
              }
            }
          });
          container.appendChild(box);
        }
      }
    }


    async function sleep(time) {
      return new Promise((resolve, reject) => {
        setTimeout(resolve, time);
      })
    }

    /**
     * @description: 寻路
     * @param map {Array} 地图数据 
     * @param start {Number} 起点
     * @return {Boolean} 是否能到达
     * @param end {Number} 目标点
     */
    async function findPath(map, start, end) {
      let table = Object.create(map); //复制一份地图坐标点
      let queue = [start];

      async function insert(x, y, pre) {
        if (x < 0 || x >= 100 || y < 0 || y >= 100) {
          // 超出边界
          return;
        }
        if (table[y * 100 + x]) {
          return;
        }

        //await sleep(1);
        container.children[y * 100 + x].style.backgroundColor = 'lightgreen';
        // 将原来坐标点作为 新的点
        table[y * 100 + x] = pre;
        queue.push([x, y]);
      }

      while (queue.length) {
        let [x, y] = queue.shift();
        if (x === end[0] && y === end[1]) {
          let path = [];

          while (x != start[0] || y != start[1]) {
            path.push(map[y * 100 + x]);
            [x, y] = table[y * 100 + x];
            await sleep(50);
            container.children[y * 100 + x].style.backgroundColor = 'purple';
          }

          // 找到了
          return path;
        }
        // [x, y]: 把原来的坐标点转递过去
        await insert(x - 1, y, [x, y]); // top
        await insert(x, y - 1, [x, y]); // left
        await insert(x + 1, y, [x, y]); // right 
        await insert(x, y + 1, [x, y]); // bottom

        // 处理斜向坐标
        await insert(x - 1, y - 1, [x, y]); // left-top
        await insert(x + 1, y - 1, [x, y]); // right-top
        await insert(x - 1, y + 1, [x, y]); // left-bottom
        await insert(x + 1, y + 1, [x, y]); // right-bottom
      }

      return null;

    }

    render(map);

  </script>
</body>
</html>